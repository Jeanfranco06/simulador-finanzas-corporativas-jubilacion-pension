{% extends "base.html" %}

{% block title %}Módulo C - Valoración de Bonos{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="bg-purple-600 text-white px-6 py-4">
            <h2 class="text-2xl font-bold flex items-center">
                <i class="fas fa-coins mr-2"></i>
                Módulo C: Valoración de Bonos
            </h2>
        </div>
        <div class="p-6">
            <p class="text-gray-700 mb-6">
                Calcula el valor presente de un bono con cupones periódicos.
                Todos los valores están en dólares estadounidenses (USD).
            </p>

            <!-- Formulario -->
            <form method="POST" class="space-y-6 mb-8">
                {{ form.hidden_tag() }}

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Características del Bono -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-800 border-b border-gray-200 pb-2">Características
                            del Bono</h3>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor Nominal (USD)</label>
                            {{ form.valor_nominal(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm
                            focus:border-purple-500 focus:ring-purple-500") }}
                            {% if form.valor_nominal.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.valor_nominal.errors[0] }}</p>
                            {% endif %}
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tasa Cupón Anual (%)</label>
                            {{ form.tasa_cupon(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm
                            focus:border-purple-500 focus:ring-purple-500") }}
                            {% if form.tasa_cupon.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.tasa_cupon.errors[0] }}</p>
                            {% endif %}
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Frecuencia de Pago de
                                Cupones</label>
                            {{ form.frecuencia_pago(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm
                            focus:border-purple-500 focus:ring-purple-500") }}
                        </div>
                    </div>

                    <!-- Condiciones de Mercado -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-800 border-b border-gray-200 pb-2">Condiciones de
                            Mercado</h3>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Plazo al Vencimiento
                                (Años)</label>
                            {{ form.años_bono(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm
                            focus:border-purple-500 focus:ring-purple-500") }}
                            {% if form.años_bono.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.años_bono.errors[0] }}</p>
                            {% endif %}
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tasa de Retorno Esperada - TEA
                                (%)</label>
                            {{ form.tea_retorno(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm
                            focus:border-purple-500 focus:ring-purple-500") }}
                            {% if form.tea_retorno.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.tea_retorno.errors[0] }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="text-center">
                    {{ form.submit(class="bg-purple-600 text-white px-8 py-3 rounded-lg hover:bg-purple-700
                    transition-colors font-medium") }}
                </div>
            </form>

            <!-- Resultados -->
            {% if resultado %}
            <hr class="my-8">
            <h3 class="text-xl font-semibold text-gray-800 mb-6">Resultados de la Valoración</h3>

            <!-- Métricas principales -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="bg-gradient-to-r from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-purple-600">${{
                            "%.2f"|format(resultado.resumen.valor_presente_total) }}</div>
                        <div class="text-sm text-gray-600">Valor Presente</div>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600">${{ "%.2f"|format(resultado.resumen.valor_nominal)
                            }}</div>
                        <div class="text-sm text-gray-600">Valor Nominal</div>
                    </div>
                </div>

                <div class="bg-gradient-to-r
                        {% if resultado.resumen.estado == 'Prima' %}from-green-50 to-green-100 border-green-200
                        {% elif resultado.resumen.estado == 'Descuento' %}from-red-50 to-red-100 border-red-200
                        {% else %}from-yellow-50 to-yellow-100 border-yellow-200{% endif %}
                        p-4 rounded-lg border">
                    <div class="text-center">
                        <div class="text-2xl font-bold
                                {% if resultado.resumen.estado == 'Prima' %}text-green-600
                                {% elif resultado.resumen.estado == 'Descuento' %}text-red-600
                                {% else %}text-yellow-600{% endif %}">
                            {{ resultado.resumen.estado }}
                        </div>
                        <div class="text-sm text-gray-600">Estado del Bono</div>
                    </div>
                </div>
            </div>

            <!-- Interpretación -->
            <div class="mb-8 p-4 rounded-lg
                    {% if resultado.resumen.estado == 'Prima' %}bg-green-50 border border-green-200
                    {% elif resultado.resumen.estado == 'Descuento' %}bg-red-50 border border-red-200
                    {% else %}bg-yellow-50 border border-yellow-200{% endif %}">
                <div class="flex items-center mb-2">
                    <i class="fas
                            {% if resultado.resumen.estado == 'Prima' %}fa-arrow-up text-green-600
                            {% elif resultado.resumen.estado == 'Descuento' %}fa-arrow-down text-red-600
                            {% else %}fa-equals text-yellow-600{% endif %} mr-2"></i>
                    <h4 class="font-semibold
                            {% if resultado.resumen.estado == 'Prima' %}text-green-800
                            {% elif resultado.resumen.estado == 'Descuento' %}text-red-800
                            {% else %}text-yellow-800{% endif %}">
                        Bono cotiza con {{ resultado.resumen.estado|upper }}
                    </h4>
                </div>
                <p class="text-gray-700">
                    {% if resultado.resumen.estado == 'Prima' %}
                    El bono tiene un valor presente mayor al nominal porque la tasa cupón ({{
                    "%.2f"|format(resultado.resumen.tasa_cupon) }}%)
                    es mayor a la tasa de retorno requerida ({{ "%.2f"|format(resultado.resumen.tea_retorno) }}%).
                    {% elif resultado.resumen.estado == 'Descuento' %}
                    El bono tiene un valor presente menor al nominal porque la tasa cupón ({{
                    "%.2f"|format(resultado.resumen.tasa_cupon) }}%)
                    es menor a la tasa de retorno requerida ({{ "%.2f"|format(resultado.resumen.tea_retorno) }}%).
                    {% else %}
                    El bono tiene un valor presente igual al nominal porque las tasas son equivalentes.
                    {% endif %}
                </p>
            </div>

            <!-- Gráfica -->
            <div class="mb-8">
                <h4 class="text-lg font-semibold text-gray-800 mb-4">Flujos del Bono</h4>
                <div class="bg-white p-4 rounded-lg border border-gray-200">
                    <canvas id="graficaBonos" width="400" height="200"
                        data-chart-data="{{ resultado.dataframe.to_dict('records') | tojson }}"></canvas>
                </div>
            </div>

            <!-- Tabla de flujos -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-gray-800 mb-4">Tabla de Flujos</h4>
                <div class="overflow-x-auto bg-white rounded-lg border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Periodo</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Flujo (USD)</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Valor Presente (USD)</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for _, row in resultado.dataframe.iterrows() %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ row['Periodo'] }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${{
                                    "%.2f"|format(row['Flujo (USD)']) }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${{
                                    "%.2f"|format(row['Valor Presente (USD)']) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Botones de acción -->
            <div class="text-center">
                <button onclick="window.print()"
                    class="inline-flex items-center bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors font-medium">
                    <i class="fas fa-print mr-2"></i> Imprimir
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% block scripts %}
<script>
    // AJAX form submission
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;

            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Calculando...';

            try {
                const formData = new FormData(form);
                const response = await fetch(window.location.pathname, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // Update results section
                    updateBonosResults(data.resultado);
                    // Scroll to results
                    document.getElementById('results-section')?.scrollIntoView({ behavior: 'smooth' });
                } else {
                    // Show error
                    showError(data.error || 'Error en el cálculo');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Error de conexión. Inténtalo de nuevo.');
            } finally {
                // Restore button
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });
    }

    function updateBonosResults(resultado) {
        // Create results HTML
        const resultsHTML = `
            <div class="space-y-8" id="results-section">
                <hr class="my-8">
                <h3 class="text-xl font-semibold text-gray-800 mb-6">Resultados de la Valoración</h3>

                <!-- Métricas principales -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div class="bg-gradient-to-r from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-600">$${resultado.resumen.valor_presente_total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            <div class="text-sm text-gray-600">Valor Presente</div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600">$${resultado.resumen.valor_nominal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            <div class="text-sm text-gray-600">Valor Nominal</div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-r
                        ${resultado.resumen.estado === 'Prima' ? 'from-green-50 to-green-100 border-green-200' :
                          resultado.resumen.estado === 'Descuento' ? 'from-red-50 to-red-100 border-red-200' :
                          'from-yellow-50 to-yellow-100 border-yellow-200'}
                        p-4 rounded-lg border">
                        <div class="text-center">
                            <div class="text-2xl font-bold
                                ${resultado.resumen.estado === 'Prima' ? 'text-green-600' :
                                  resultado.resumen.estado === 'Descuento' ? 'text-red-600' :
                                  'text-yellow-600'}">
                                ${resultado.resumen.estado}
                            </div>
                            <div class="text-sm text-gray-600">Estado del Bono</div>
                        </div>
                    </div>
                </div>

                <!-- Interpretación -->
                <div class="mb-8 p-4 rounded-lg
                    ${resultado.resumen.estado === 'Prima' ? 'bg-green-50 border border-green-200' :
                      resultado.resumen.estado === 'Descuento' ? 'bg-red-50 border border-red-200' :
                      'bg-yellow-50 border border-yellow-200'}">
                    <div class="flex items-center mb-2">
                        <i class="fas
                            ${resultado.resumen.estado === 'Prima' ? 'fa-arrow-up text-green-600' :
                              resultado.resumen.estado === 'Descuento' ? 'fa-arrow-down text-red-600' :
                              'fa-equals text-yellow-600'} mr-2"></i>
                        <h4 class="font-semibold
                            ${resultado.resumen.estado === 'Prima' ? 'text-green-800' :
                              resultado.resumen.estado === 'Descuento' ? 'text-red-800' :
                              'text-yellow-800'}">
                            Bono cotiza con ${resultado.resumen.estado.toUpperCase()}
                        </h4>
                    </div>
                    <p class="text-gray-700">
                        ${resultado.resumen.estado === 'Prima' ?
                            `El bono tiene un valor presente mayor al nominal porque la tasa cupón (${resultado.resumen.tasa_cupon.toFixed(2)}%) es mayor a la tasa de retorno requerida (${resultado.resumen.tea_retorno.toFixed(2)}%).` :
                          resultado.resumen.estado === 'Descuento' ?
                            `El bono tiene un valor presente menor al nominal porque la tasa cupón (${resultado.resumen.tasa_cupon.toFixed(2)}%) es menor a la tasa de retorno requerida (${resultado.resumen.tea_retorno.toFixed(2)}%).` :
                            'El bono tiene un valor presente igual al nominal porque las tasas son equivalentes.'
                        }
                    </p>
                </div>

                <!-- Gráfica -->
                <div class="mb-8">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">Flujos del Bono</h4>
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <canvas id="graficaBonos" width="400" height="200"></canvas>
                    </div>
                </div>

                <!-- Tabla de flujos -->
                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">Tabla de Flujos</h4>
                    <div class="overflow-x-auto bg-white rounded-lg border border-gray-200">
                        ${resultado.dataframe_html}
                    </div>
                </div>

                <!-- Botones de acción -->
                <div class="text-center">
                    <button onclick="window.print()"
                            class="inline-flex items-center bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors font-medium">
                        <i class="fas fa-print mr-2"></i> Imprimir
                    </button>
                </div>
            </div>
        `;

        // Remove existing results and add new ones
        const existingResults = document.getElementById('results-section');
        if (existingResults) {
            existingResults.remove();
        }

        // Add new results after the form
        const formElement = document.querySelector('form');
        formElement.insertAdjacentHTML('afterend', resultsHTML);

        // Initialize chart
        initializeBonosChart();
    }

    function initializeBonosChart() {
        // This will be called after results are updated
        // Chart initialization logic would go here
        console.log('Chart should be initialized here');
    }

    function showError(message) {
        // Create error alert
        const alertHTML = `
            <div class="p-4 rounded-xl shadow-sm border-l-4 border-red-500 bg-red-50 text-red-800 mb-6">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-red-500 mr-3"></i>
                    <div class="flex-1">${message}</div>
                    <button type="button" class="text-red-400 hover:text-red-600 ml-4" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;

        // Add error before form
        const formElement = document.querySelector('form');
        formElement.insertAdjacentHTML('beforebegin', alertHTML);
    }
</script>
{% endblock %}
{% endblock %}
