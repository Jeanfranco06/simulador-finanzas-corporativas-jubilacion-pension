{% extends "base.html" %}

{% block title %}Módulo B - Proyección de Jubilación{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="bg-green-600 text-white px-6 py-4">
            <h2 class="text-2xl font-bold flex items-center">
                <i class="fas fa-home mr-2"></i>
                Módulo B: Proyección de Jubilación
            </h2>
        </div>
        <div class="p-6">
            <p class="text-gray-700 mb-6">
                Calcula tu pensión mensual estimada considerando impuestos sobre las ganancias.
            </p>

            {% if not modulo_a_completado %}
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                    <div>
                        <strong class="text-red-800">Atención:</strong>
                        <span class="text-red-700">Este módulo requiere que primero calcules tu cartera en el <a href="{{ url_for('main.cartera') }}" class="text-red-800 underline hover:text-red-900">Módulo A</a>.</span>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                <div class="flex items-center">
                    <i class="fas fa-check-circle text-green-600 mr-2"></i>
                    <div>
                        <strong class="text-green-800">Módulo A completado:</strong>
                        <span class="text-green-700">Capital acumulado: ${{ "%.2f"|format(session['cartera_resumen']['capital_final']) }}</span>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Formulario -->
            <form method="POST" class="space-y-6">
                {{ form.hidden_tag() }}

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Tipo de Retiro -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Tipo de Retiro</h3>

                        <div class="space-y-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Retiro</label>
                            {% for subfield in form.tipo_retiro %}
                                <div class="flex items-center">
                                    {{ subfield(class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300") }}
                                    {{ subfield.label(class="ml-2 block text-sm text-gray-900") }}
                                </div>
                            {% endfor %}
                        </div>

                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Impuesto</label>
                            {{ form.tipo_impuesto(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500") }}
                        </div>
                    </div>

                    <!-- Configuración de Pensión -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Configuración de Pensión</h3>

                        <div id="años_retiro_field" class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Años Esperados de Retiro</label>
                            {{ form.años_retiro(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500") }}
                            {% if form.años_retiro.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.años_retiro.errors[0] }}</p>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Usar la misma TEA del Módulo A</label>
                            <div class="flex items-center">
                                {{ form.usar_misma_tea(class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded") }}
                                {{ form.usar_misma_tea.label(class="ml-2 block text-sm text-gray-900") }}
                            </div>
                        </div>

                        <div id="tea_retiro_field" class="mb-4" style="display: none;">
                            <label class="block text-sm font-medium text-gray-700 mb-2">TEA durante el Retiro (%)</label>
                            {{ form.tea_retiro(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500") }}
                            {% if form.tea_retiro.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.tea_retiro.errors[0] }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="text-center">
                    {{ form.submit(class="bg-green-600 text-white px-8 py-3 rounded-lg hover:bg-green-700 transition-colors font-medium") }}
                </div>
            </form>

            <!-- Resultados -->
            {% if resultado and resultado.mensaje != 'Este módulo requiere datos del Módulo A primero' %}
                <hr class="my-8">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Resultados de la Proyección de Jubilación</h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Información General -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-blue-800 mb-3">Información General</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-blue-700">Tipo de Retiro:</span>
                                <span class="font-medium">{{ "Pensión Mensual" if resultado.tipo_retiro == 'pension' else "Retiro Total" }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-blue-700">Tipo de Impuesto:</span>
                                <span class="font-medium">{{ resultado.tipo_impuesto.title() }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-blue-700">Capital Inicial:</span>
                                <span class="font-medium">${{ "%.2f"|format(resultado.capital_inicial) }}</span>
                            </div>
                            {% if resultado.tipo_retiro == 'pension' %}
                            <div class="flex justify-between">
                                <span class="text-blue-700">Años de Retiro:</span>
                                <span class="font-medium">{{ resultado.años_retiro }}</span>
                            </div>
                            {% endif %}
                            <div class="flex justify-between">
                                <span class="text-blue-700">TEA de Retiro:</span>
                                <span class="font-medium">{{ "%.2f"|format(resultado.tea_retiro) }}%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Resumen Financiero -->
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-green-800 mb-3">Resumen Financiero</h4>
                        <div class="space-y-2 text-sm">
                            {% if resultado.tipo_retiro == 'pension' %}
                            <div class="flex justify-between">
                                <span class="text-green-700">Pensión Mensual Bruta:</span>
                                <span class="font-medium">${{ "%.2f"|format(resultado.pension_mensual_bruta) }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-green-700">Impuesto Mensual:</span>
                                <span class="font-medium">${{ "%.2f"|format(resultado.impuesto_mensual) }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-green-700">Pensión Mensual Neta:</span>
                                <span class="font-medium font-bold text-green-800">${{ "%.2f"|format(resultado.pension_mensual_neta) }}</span>
                            </div>
                            {% else %}
                            <div class="flex justify-between">
                                <span class="text-green-700">Retiro Total Bruto:</span>
                                <span class="font-medium">${{ "%.2f"|format(resultado.pension_mensual_bruta) }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-green-700">Impuesto Total:</span>
                                <span class="font-medium">${{ "%.2f"|format(resultado.impuesto_mensual) }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-green-700">Retiro Total Neto:</span>
                                <span class="font-medium font-bold text-green-800">${{ "%.2f"|format(resultado.pension_mensual_neta) }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Resumen Anual -->
                {% if resultado.tipo_retiro == 'pension' %}
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold text-yellow-800 mb-3">Proyección Anual</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-yellow-800">${{ "%.2f"|format(resultado.pension_anual_bruta) }}</div>
                            <div class="text-yellow-700">Ingreso Bruto Anual</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-red-600">${{ "%.2f"|format(resultado.impuesto_anual) }}</div>
                            <div class="text-yellow-700">Impuestos Anuales</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-800">${{ "%.2f"|format(resultado.pension_anual_neta) }}</div>
                            <div class="text-yellow-700">Ingreso Neto Anual</div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Mensaje de Éxito -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-green-600 mr-2"></i>
                        <div>
                            <strong class="text-green-800">{{ resultado.mensaje }}</strong>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

{% block scripts %}
<script>
    // Toggle TEA field
    const usarTeaCheckbox = document.getElementById('usar_misma_tea');
    const teaField = document.getElementById('tea_retiro_field');

    if (usarTeaCheckbox) {
        usarTeaCheckbox.addEventListener('change', function() {
            teaField.style.display = this.checked ? 'none' : 'block';
        });
    }

    // Toggle años retiro field
    document.querySelectorAll('input[name="tipo_retiro"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const añosField = document.getElementById('años_retiro_field');
            añosField.style.display = this.value === 'pension' ? 'block' : 'none';
        });
    });

    // AJAX form submission
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;

            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Calculando...';

            try {
                const formData = new FormData(form);
                const response = await fetch(window.location.pathname, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // Update results section
                    updateJubilacionResults(data.resultado, data.modulo_a_completado);
                    // Scroll to results
                    document.getElementById('results-section')?.scrollIntoView({ behavior: 'smooth' });
                } else {
                    // Show error
                    showError(data.error || 'Error en el cálculo');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Error de conexión. Inténtalo de nuevo.');
            } finally {
                // Restore button
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });
    }

    function updateJubilacionResults(resultado, moduloACompletado) {
        // Create results HTML
        let resultsHTML = `<div class="space-y-8" id="results-section">`;

        // Module A status
        if (moduloACompletado) {
            resultsHTML += `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-green-600 mr-2"></i>
                        <div>
                            <strong class="text-green-800">Módulo A completado:</strong>
                            <span class="text-green-700">Capital acumulado: $${resultado.capital_inicial.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Results section
        resultsHTML += `
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Resultados de la Proyección de Jubilación</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Información General -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-blue-800 mb-3">Información General</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-blue-700">Tipo de Retiro:</span>
                            <span class="font-medium">${resultado.tipo_retiro === 'pension' ? 'Pensión Mensual' : 'Retiro Total'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-blue-700">Tipo de Impuesto:</span>
                            <span class="font-medium">${resultado.tipo_impuesto}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-blue-700">Capital Inicial:</span>
                            <span class="font-medium">$${resultado.capital_inicial.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                        </div>
                        ${resultado.tipo_retiro === 'pension' ? `
                        <div class="flex justify-between">
                            <span class="text-blue-700">Años de Retiro:</span>
                            <span class="font-medium">${resultado.años_retiro}</span>
                        </div>
                        ` : ''}
                        <div class="flex justify-between">
                            <span class="text-blue-700">TEA de Retiro:</span>
                            <span class="font-medium">${resultado.tea_retiro.toFixed(2)}%</span>
                        </div>
                    </div>
                </div>

                <!-- Resumen Financiero -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-green-800 mb-3">Resumen Financiero</h4>
                    <div class="space-y-2 text-sm">
                        ${resultado.tipo_retiro === 'pension' ? `
                        <div class="flex justify-between">
                            <span class="text-green-700">Pensión Mensual Bruta:</span>
                            <span class="font-medium">$${resultado.pension_mensual_bruta.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-green-700">Impuesto Mensual:</span>
                            <span class="font-medium">$${resultado.impuesto_mensual.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-green-700">Pensión Mensual Neta:</span>
                            <span class="font-medium font-bold text-green-800">$${resultado.pension_mensual_neta.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                        </div>
                        ` : `
                        <div class="flex justify-between">
                            <span class="text-green-700">Retiro Total Bruto:</span>
                            <span class="font-medium">$${resultado.pension_mensual_bruta.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-green-700">Impuesto Total:</span>
                            <span class="font-medium">$${resultado.impuesto_mensual.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-green-700">Retiro Total Neto:</span>
                            <span class="font-medium font-bold text-green-800">$${resultado.pension_mensual_neta.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                        </div>
                        `}
                    </div>
                </div>
            </div>

            ${resultado.tipo_retiro === 'pension' ? `
            <!-- Resumen Anual -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                <h4 class="text-lg font-semibold text-yellow-800 mb-3">Proyección Anual</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-yellow-800">$${resultado.pension_anual_bruta.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div class="text-yellow-700">Ingreso Bruto Anual</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-red-600">$${resultado.impuesto_anual.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div class="text-yellow-700">Impuestos Anuales</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-800">$${resultado.pension_anual_neta.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div class="text-yellow-700">Ingreso Neto Anual</div>
                    </div>
                </div>
            </div>
            ` : ''}

            <!-- Mensaje de Éxito -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <div class="flex items-center">
                    <i class="fas fa-check-circle text-green-600 mr-2"></i>
                    <div>
                        <strong class="text-green-800">${resultado.mensaje}</strong>
                    </div>
                </div>
            </div>
        `;

        resultsHTML += `</div>`;

        // Remove existing results and add new ones
        const existingResults = document.getElementById('results-section');
        if (existingResults) {
            existingResults.remove();
        }

        // Add new results after the form
        const formElement = document.querySelector('form');
        formElement.insertAdjacentHTML('afterend', resultsHTML);
    }

    function showError(message) {
        // Create error alert
        const alertHTML = `
            <div class="p-4 rounded-xl shadow-sm border-l-4 border-red-500 bg-red-50 text-red-800 mb-6">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-red-500 mr-3"></i>
                    <div class="flex-1">${message}</div>
                    <button type="button" class="text-red-400 hover:text-red-600 ml-4" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;

        // Add error before form
        const formElement = document.querySelector('form');
        formElement.insertAdjacentHTML('beforebegin', alertHTML);
    }
</script>
{% endblock %}
{% endblock %}
