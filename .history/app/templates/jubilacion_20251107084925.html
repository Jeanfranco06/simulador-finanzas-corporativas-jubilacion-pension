{% extends "base.html" %}

{% block title %}M√≥dulo B - Proyecci√≥n de Jubilaci√≥n{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="bg-gradient-to-r from-green-600 to-green-700 text-white">
    <div class="max-w-7xl mx-auto px-4 py-16">
        <div class="text-center">
            <div class="inline-flex items-center justify-center w-20 h-20 bg-white/10 rounded-full mb-6">
                <i class="fas fa-piggy-bank text-3xl"></i>
            </div>
            <h1 class="text-4xl md:text-5xl font-bold mb-4">
                Proyecci√≥n de Jubilaci√≥n
            </h1>
            <p class="text-xl text-green-100 max-w-2xl mx-auto">
                Calcula tu pensi√≥n mensual estimada considerando impuestos sobre las ganancias
            </p>
            <div class="mt-6 inline-flex items-center bg-white/20 backdrop-blur-sm rounded-full px-4 py-2">
                <i class="fas fa-dollar-sign mr-2"></i>
                <span class="font-medium">Todos los c√°lculos en USD</span>
            </div>
        </div>
    </div>
</div>

<div class="max-w-6xl mx-auto -mt-8 relative z-10">
    {% if modulo_a_completado %}
    <!-- Module A Summary - Full Width -->
    <div class="bg-white rounded-2xl shadow-xl border border-secondary-200 overflow-hidden mb-8">
        <div class="bg-gradient-to-r from-green-50 to-green-100 px-8 py-6 border-b border-green-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-4">
                        <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-green-900">M√≥dulo A Completado</h2>
                        <p class="text-green-700 mt-1">Datos disponibles para proyecci√≥n de jubilaci√≥n</p>
                    </div>
                </div>
                <a href="{{ url_for('main.cartera') }}"
                   class="inline-flex items-center bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-all duration-200 font-semibold shadow-lg hover:shadow-xl">
                    <i class="fas fa-edit mr-2"></i>
                    Modificar Datos
                </a>
            </div>
        </div>

        <div class="p-8">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl border border-blue-200 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-user text-blue-600 text-xl"></i>
                        </div>
                        <span class="text-xs font-medium text-blue-600 bg-blue-100 px-2 py-1 rounded-full">EDAD</span>
                    </div>
                    <div class="text-2xl font-bold text-blue-900 mb-1">{{ session['cartera_datos']['edad_actual'] if session['cartera_datos'] else 'N/A' }}</div>
                    <div class="text-sm text-blue-700 font-medium">A√±os Actuales</div>
                </div>

                <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-xl border border-green-200 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-dollar-sign text-green-600 text-xl"></i>
                        </div>
                        <span class="text-xs font-medium text-green-600 bg-green-100 px-2 py-1 rounded-full">INICIAL</span>
                    </div>
                    <div class="text-2xl font-bold text-green-900 mb-1">${{ "%.2f"|format(session['cartera_datos']['monto_inicial']) if session['cartera_datos'] else 'N/A' }}</div>
                    <div class="text-sm text-green-700 font-medium">Monto Inicial</div>
                </div>

                <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-xl border border-purple-200 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-calendar text-purple-600 text-xl"></i>
                        </div>
                        <span class="text-xs font-medium text-purple-600 bg-purple-100 px-2 py-1 rounded-full">PER√çODO</span>
                    </div>
                    <div class="text-2xl font-bold text-purple-900 mb-1">
                        {% if session['cartera_datos'] %}
                            {% if session['cartera_datos']['tipo_plazo'] == 'a√±os' %}
                                {{ session['cartera_datos']['a√±os'] }} a√±os
                            {% else %}
                                Hasta {{ session['cartera_datos']['edad_retiro'] }} a√±os
                            {% endif %}
                        {% else %}
                            N/A
                        {% endif %}
                    </div>
                    <div class="text-sm text-purple-700 font-medium">Per√≠odo de Ahorro</div>
                </div>

                <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-6 rounded-xl border border-orange-200 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-piggy-bank text-orange-600 text-xl"></i>
                        </div>
                        <span class="text-xs font-medium text-orange-600 bg-orange-100 px-2 py-1 rounded-full">FINAL</span>
                    </div>
                    <div class="text-2xl font-bold text-orange-900 mb-1">${{ "%.2f"|format(session['cartera_resumen']['capital_final']) }}</div>
                    <div class="text-sm text-orange-700 font-medium">Capital Final</div>
                </div>
            </div>

            <!-- Detailed Information -->
            <div class="bg-secondary-50 rounded-xl p-6">
                <h3 class="text-lg font-semibold text-secondary-900 mb-4 flex items-center">
                    <i class="fas fa-info-circle text-secondary-600 mr-2"></i>
                    Detalles del M√≥dulo A
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white rounded-lg p-4 border border-secondary-200">
                        <div class="flex items-center mb-3">
                            <i class="fas fa-money-bill-wave text-green-600 mr-2"></i>
                            <span class="font-medium text-secondary-900">Aporte Peri√≥dico</span>
                        </div>
                        <div class="text-2xl font-bold text-green-800">${{ "%.2f"|format(session['cartera_datos']['aporte_periodico']) if session['cartera_datos'] else 'N/A' }}</div>
                        <div class="text-sm text-secondary-600">
                            {% if session['cartera_datos'] %}
                                {{ session['cartera_datos']['frecuencia'].title() }}
                            {% endif %}
                        </div>
                    </div>

                    <div class="bg-white rounded-lg p-4 border border-secondary-200">
                        <div class="flex items-center mb-3">
                            <i class="fas fa-percentage text-blue-600 mr-2"></i>
                            <span class="font-medium text-secondary-900">TEA</span>
                        </div>
                        <div class="text-2xl font-bold text-blue-800">
                            {% if session['cartera_resumen'] %}
                                {% set tea_value = session['cartera_resumen'].get('tea_equivalente', session['cartera_resumen'].get('tea', 'N/A')) %}
                                {% if tea_value != 'N/A' %}
                                    {{ "%.1f"|format(tea_value) }}%
                                {% else %}
                                    N/A
                                {% endif %}
                            {% else %}
                                N/A
                            {% endif %}
                        </div>
                        <div class="text-sm text-secondary-600">TEA Equivalente</div>
                        {% if session['cartera_resumen'] %}
                        <div class="text-xs text-secondary-500 mt-1">
                            Ingresada:
                            {% set tea_ingresada_value = session['cartera_resumen'].get('tea_ingresada', session['cartera_resumen'].get('tea', 'N/A')) %}
                            {% if tea_ingresada_value != 'N/A' %}
                                {{ "%.1f"|format(tea_ingresada_value) }}%
                            {% else %}
                                N/A
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>

                    <div class="bg-white rounded-lg p-4 border border-secondary-200">
                        <div class="flex items-center mb-3">
                            <i class="fas fa-chart-line text-purple-600 mr-2"></i>
                            <span class="font-medium text-secondary-900">Rentabilidad</span>
                        </div>
                        <div class="text-2xl font-bold text-purple-800">{{ "%.1f"|format(session['cartera_resumen']['rentabilidad']) if session['cartera_resumen'] else 'N/A' }}%</div>
                        <div class="text-sm text-secondary-600">Total Acumulada</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Input Form Card -->
    <div class="bg-white rounded-2xl shadow-xl border border-secondary-200 overflow-hidden mb-8">
        <div class="bg-secondary-50 px-8 py-6 border-b border-secondary-200">
            <h2 class="text-2xl font-bold text-secondary-900 flex items-center">
                <i class="fas fa-calculator text-green-600 mr-3"></i>
                Par√°metros de Jubilaci√≥n
            </h2>
            <p class="text-secondary-600 mt-2">Ingresa los datos para calcular tu proyecci√≥n de jubilaci√≥n</p>
        </div>

        {% if not modulo_a_completado %}
        <div class="p-8">
            <div class="bg-red-50 border border-red-200 rounded-xl p-6 text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mb-4">
                    <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-red-800 mb-2">M√≥dulo A Requerido</h3>
                <p class="text-red-700 mb-4">Este m√≥dulo requiere que primero calcules tu cartera en el M√≥dulo A.</p>
                <a href="{{ url_for('main.cartera') }}"
                   class="inline-flex items-center bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors font-medium">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Ir al M√≥dulo A
                </a>
            </div>
        </div>
        {% else %}

        <form method="POST" class="p-8">
            {{ form.hidden_tag() }}

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Retirement Type -->
                <div class="space-y-6">
                    <div class="bg-secondary-50 rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-secondary-900 mb-4 flex items-center">
                            <i class="fas fa-hand-holding-usd text-green-600 mr-2"></i>
                            Tipo de Retiro
                        </h3>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-secondary-700 mb-3">
                                    <i class="fas fa-info-circle mr-1"></i>¬øC√≥mo deseas retirar tus fondos?
                                    <button type="button" class="ml-1 text-secondary-400 hover:text-secondary-600 transition-colors help-btn" data-help="Pensi√≥n Mensual: Recibes pagos fijos mensuales durante a√±os. Retiro Total: Retiras todo el capital de una vez. Renta v√≠a Dividendos: Solo recibes intereses/dividendos generados por el capital acumulado, sin retirar ni reducir el fondo principal. Se calcula como la mitad de la TEA durante el retiro aplicada al capital final, dividido en pagos mensuales.">
                                        <i class="fas fa-question-circle text-xs"></i>
                                    </button>
                                </label>
                                <div class="space-y-3">
                                    {% for subfield in form.tipo_retiro %}
                                        <div class="flex items-center p-3 bg-white rounded-lg border border-secondary-200 hover:border-green-300 transition-colors">
                                            {{ subfield(class="h-4 w-4 text-green-600 focus:ring-green-500 border-secondary-300") }}
                                            {{ subfield.label(class="ml-3 block text-sm font-medium text-secondary-900") }}
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary-700 mb-2">
                                    <i class="fas fa-file-invoice-dollar mr-1"></i>Tipo de Impuesto sobre Ganancia
                                    <button type="button" class="ml-1 text-secondary-400 hover:text-secondary-600 transition-colors help-btn" data-help="Fuente Extranjera (29.5%): Para inversiones en el extranjero. Bolsa Local (5%): Para inversiones en bolsa peruana.">
                                        <i class="fas fa-question-circle text-xs"></i>
                                    </button>
                                </label>
                                {{ form.tipo_impuesto(class="w-full px-4 py-3 border border-secondary-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors", style="background-color: white; color: #374151; border-color: #d1d5db;") }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Financial Situation -->
                <div class="space-y-6">
                    <div class="bg-secondary-50 rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-secondary-900 mb-4 flex items-center">
                            <i class="fas fa-cogs text-green-600 mr-2"></i>
                            Configuraci√≥n de Pensi√≥n
                        </h3>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-secondary-700 mb-2">
                                    <i class="fas fa-calendar-alt mr-1"></i>Edad de Jubilaci√≥n
                                    <button type="button" class="ml-1 text-secondary-400 hover:text-secondary-600 transition-colors help-btn" data-help="{% if session['cartera_datos'] and session['cartera_datos']['tipo_plazo'] == 'a√±os' %}Este valor se calcula autom√°ticamente basado en los a√±os especificados en el M√≥dulo A (edad actual + a√±os).{% else %}Edad a la que planeas jubilarte. Puedes modificar este valor seg√∫n tus necesidades.{% endif %}">
                                        <i class="fas fa-question-circle text-xs"></i>
                                    </button>
                                </label>
                                {{ form.edad_jubilacion(class="w-full px-4 py-3 border border-secondary-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors", placeholder="Ej: 65", style="background-color: white; color: #374151; border-color: #d1d5db;", readonly=True) }}
                                {% if session['cartera_datos'] and session['cartera_datos']['tipo_plazo'] == 'a√±os' %}
                                    <div class="mt-2 text-sm text-blue-600 bg-blue-50 p-2 rounded-md border border-blue-200">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Calculado autom√°ticamente: {{ session['cartera_datos']['edad_actual'] }} a√±os (edad actual) + {{ session['cartera_datos']['a√±os'] }} a√±os = {{ session['cartera_datos']['edad_actual'] + session['cartera_datos']['a√±os'] }} a√±os
                                    </div>
                                {% endif %}
                                {% if form.edad_jubilacion.errors %}
                                    <p class="mt-1 text-sm text-red-600 flex items-center">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>{{ form.edad_jubilacion.errors[0] }}
                                    </p>
                                {% endif %}
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-secondary-700 mb-3">
                                    <i class="fas fa-sync-alt mr-1"></i>TEA durante el Retiro
                                    <button type="button" class="ml-1 text-secondary-400 hover:text-secondary-600 transition-colors help-btn" data-help="Usar la misma TEA del m√≥dulo A o especificar una tasa diferente para el per√≠odo de retiro.">
                                        <i class="fas fa-question-circle text-xs"></i>
                                    </button>
                                </label>
                                <div class="space-y-3">
                                    <div class="flex items-center p-3 bg-white rounded-lg border border-secondary-200 hover:border-green-300 transition-colors">
                                        {{ form.usar_misma_tea(class="h-4 w-4 text-green-600 focus:ring-green-500 border-secondary-300") }}
                                        {{ form.usar_misma_tea.label(class="ml-3 block text-sm font-medium text-secondary-900") }}
                                    </div>
                                </div>
                            </div>

                            <div id="tea_retiro_field" style="display: none;">
                                <label class="block text-sm font-medium text-secondary-700 mb-2">
                                    <i class="fas fa-percentage mr-1"></i>TEA Personalizada (%)
                                    <button type="button" class="ml-1 text-secondary-400 hover:text-secondary-600 transition-colors help-btn" data-help="Tasa de rendimiento esperada durante el per√≠odo de retiro. Suele ser m√°s conservadora que durante el ahorro.">
                                        <i class="fas fa-question-circle text-xs"></i>
                                    </button>
                                </label>
                                {{ form.tea_retiro(class="w-full px-4 py-3 border border-secondary-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors", placeholder="Ej: 5.0", style="background-color: white; color: #374151; border-color: #d1d5db;") }}
                                {% if form.tea_retiro.errors %}
                                    <p class="mt-1 text-sm text-red-600 flex items-center">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>{{ form.tea_retiro.errors[0] }}
                                    </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-8 text-center">
                <button type="submit" class="bg-green-600 text-white px-12 py-4 rounded-xl hover:bg-green-700 transition-all duration-200 font-semibold text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 inline-flex items-center">
                    <i class="fas fa-calculator mr-3"></i>
                    {{ form.submit.label.text }}
                    <i class="fas fa-calculator ml-3"></i>
                </button>
            </div>
        </form>
        {% endif %}
    </div>

    <!-- Results Section -->
    {% if resultado and resultado.mensaje != 'Este m√≥dulo requiere datos del M√≥dulo A primero' %}
        <div class="space-y-8">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl border border-blue-200 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-info-circle text-blue-600 text-xl"></i>
                        </div>
                        <span class="text-xs font-medium text-blue-600 bg-blue-100 px-2 py-1 rounded-full">GENERAL</span>
                    </div>
                    <div class="text-2xl font-bold text-blue-900 mb-1">
                        {% if resultado.tipo_retiro == 'pension' %}Pensi√≥n{% elif resultado.tipo_retiro == 'dividendos' %}Dividendos{% else %}Retiro{% endif %}
                    </div>
                    <div class="text-sm text-blue-700 font-medium">Tipo de Retiro</div>
                </div>

                <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-xl border border-green-200 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-dollar-sign text-green-600 text-xl"></i>
                        </div>
                        <span class="text-xs font-medium text-green-600 bg-green-100 px-2 py-1 rounded-full">MENSUAL</span>
                    </div>
                    <div class="text-2xl font-bold text-green-900 mb-1">${{ "%.2f"|format(resultado.pension_mensual_neta) }}</div>
                    <div class="text-sm text-green-700 font-medium">Pensi√≥n Neta</div>
                </div>

                <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 p-6 rounded-xl border border-yellow-200 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-calendar text-yellow-600 text-xl"></i>
                        </div>
                        <span class="text-xs font-medium text-yellow-600 bg-yellow-100 px-2 py-1 rounded-full">EDAD</span>
                    </div>
                    <div class="text-2xl font-bold text-yellow-900 mb-1">{{ resultado.edad_jubilacion if resultado.edad_jubilacion else 'N/A' }}</div>
                    <div class="text-sm text-yellow-700 font-medium">Edad de Jubilaci√≥n</div>
                </div>

                <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-xl border border-purple-200 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-percentage text-purple-600 text-xl"></i>
                        </div>
                        <span class="text-xs font-medium text-purple-600 bg-purple-100 px-2 py-1 rounded-full">TEA</span>
                    </div>
                    <div class="text-2xl font-bold text-purple-900 mb-1">{{ "%.1f"|format(resultado.tea_retiro) }}%</div>
                    <div class="text-sm text-purple-700 font-medium">Tasa de Retiro</div>
                </div>
            </div>

            <!-- Detailed Results -->
            <div class="bg-white rounded-2xl shadow-xl border border-secondary-200 overflow-hidden">
                <div class="bg-secondary-50 px-8 py-6 border-b border-secondary-200">
                    <h3 class="text-2xl font-bold text-secondary-900 flex items-center">
                        <i class="fas fa-chart-bar text-green-600 mr-3"></i>
                        Detalles de la Proyecci√≥n
                    </h3>
                    <p class="text-secondary-600 mt-2">Resumen completo de tu jubilaci√≥n proyectada</p>
                </div>
                <div class="p-8">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Informaci√≥n General -->
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-6">
                            <h4 class="text-lg font-semibold text-blue-800 mb-4 flex items-center">
                                <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                                Informaci√≥n General
                            </h4>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between items-center py-2 border-b border-blue-100">
                                    <span class="text-blue-700 font-medium">Tipo de Retiro:</span>
                                    <span class="font-semibold text-blue-900" data-field="tipo_retiro">
                                        {% if resultado.tipo_retiro == 'pension' %}Pensi√≥n Mensual{% elif resultado.tipo_retiro == 'dividendos' %}Renta v√≠a Dividendos{% else %}Retiro Total{% endif %}
                                    </span>
                                </div>
                                <div class="flex justify-between items-center py-2 border-b border-blue-100">
                                    <span class="text-blue-700 font-medium">Tipo de Impuesto:</span>
                                    <span class="font-semibold text-blue-900">{{ resultado.tipo_impuesto.title() }}</span>
                                </div>
                                <div class="flex justify-between items-center py-2 border-b border-blue-100">
                                    <span class="text-blue-700 font-medium">Capital Inicial:</span>
                                    <span class="font-semibold text-blue-900">${{ "%.2f"|format(resultado.capital_inicial) }}</span>
                                </div>
                                <div class="flex justify-between items-center py-2 border-b border-blue-100">
                                    <span class="text-blue-700 font-medium">Ingresos Adicionales:</span>
                                    <span class="font-semibold text-blue-900">${{ "%.2f"|format(resultado.ingresos_adicionales) }}/mes</span>
                                </div>
                                <div class="flex justify-between items-center py-2 border-b border-blue-100">
                                    <span class="text-blue-700 font-medium">Capital Inicial:</span>
                                    <span class="font-semibold text-blue-900">$${resultado.capital_inicial.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                                </div>
                                <div class="flex justify-between items-center py-2 border-b border-blue-100" id="a√±os-retiro-row" style="display: none;">
                                    <span class="text-blue-700 font-medium">A√±os de Retiro:</span>
                                    <span class="font-semibold text-blue-900" id="a√±os-retiro-value"></span>
                                </div>
                                <div class="flex justify-between items-center py-2">
                                    <span class="text-blue-700 font-medium">TEA de Retiro:</span>
                                    <span class="font-semibold text-blue-900">${resultado.tea_retiro.toFixed(2)}%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Resumen Financiero -->
                        <div class="bg-green-50 border border-green-200 rounded-xl p-6">
                            <h4 class="text-lg font-semibold text-green-800 mb-4 flex items-center">
                                <i class="fas fa-dollar-sign text-green-600 mr-2"></i>
                                Resumen Financiero
                            </h4>
                            <div class="space-y-3 text-sm">
                                {% if resultado.tipo_retiro == 'pension' %}
                                <div class="flex justify-between items-center py-2 border-b border-green-100">
                                    <span class="text-green-700 font-medium">Pensi√≥n Mensual Bruta:</span>
                                    <span class="font-semibold text-green-900" data-field="pension_bruta">${{ "%.2f"|format(resultado.pension_mensual_bruta) }}</span>
                                </div>
                                <div class="flex justify-between items-center py-2 border-b border-green-100">
                                    <span class="text-green-700 font-medium">Impuesto Mensual:</span>
                                    <span class="font-semibold text-red-600" data-field="impuesto">${{ "%.2f"|format(resultado.impuesto_mensual) }}</span>
                                </div>
                                <div class="flex justify-between items-center py-2">
                                    <span class="text-green-700 font-medium">Pensi√≥n Mensual Neta:</span>
                                    <span class="font-bold text-green-800 text-lg" data-field="pension_neta">${{ "%.2f"|format(resultado.pension_mensual_neta) }}</span>
                                </div>
                                {% else %}
                                <div class="flex justify-between items-center py-2 border-b border-green-100">
                                    <span class="text-green-700 font-medium">Retiro Total Bruto:</span>
                                    <span class="font-semibold text-green-900" data-field="pension_bruta">${{ "%.2f"|format(resultado.pension_mensual_bruta) }}</span>
                                </div>
                                <div class="flex justify-between items-center py-2 border-b border-green-100">
                                    <span class="text-green-700 font-medium">Impuesto Total:</span>
                                    <span class="font-semibold text-red-600" data-field="impuesto">${{ "%.2f"|format(resultado.impuesto_mensual) }}</span>
                                </div>
                                <div class="flex justify-between items-center py-2">
                                    <span class="text-green-700 font-medium">Retiro Total Neto:</span>
                                    <span class="font-bold text-green-800 text-lg" data-field="pension_neta">${{ "%.2f"|format(resultado.pension_mensual_neta) }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Annual Projection (only for pension) -->
                    {% if resultado.tipo_retiro == 'pension' %}
                    <div class="mt-8 bg-yellow-50 border border-yellow-200 rounded-xl p-6">
                        <h4 class="text-lg font-semibold text-yellow-800 mb-4 flex items-center">
                            <i class="fas fa-calendar text-yellow-600 mr-2"></i>
                            Proyecci√≥n Anual
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="text-center">
                                <div class="text-3xl font-bold text-yellow-800 mb-2">${{ "%.2f"|format(resultado.pension_anual_bruta) }}</div>
                                <div class="text-sm text-yellow-700 font-medium">Ingreso Bruto Anual</div>
                            </div>
                            <div class="text-center">
                                <div class="text-3xl font-bold text-red-600 mb-2">${{ "%.2f"|format(resultado.impuesto_anual) }}</div>
                                <div class="text-sm text-yellow-700 font-medium">Impuestos Anuales</div>
                            </div>
                            <div class="text-center">
                                <div class="text-3xl font-bold text-green-800 mb-2">${{ "%.2f"|format(resultado.pension_anual_neta) }}</div>
                                <div class="text-sm text-yellow-700 font-medium">Ingreso Neto Anual</div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Success Message -->
                    <div class="mt-6 bg-green-50 border border-green-200 rounded-xl p-4">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-600 mr-3"></i>
                            <div>
                                <strong class="text-green-800">{{ resultado.mensaje }}</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scenario Comparison -->
            <div class="bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200 rounded-xl p-6">
                <h3 class="text-xl font-bold text-indigo-900 mb-4 flex items-center">
                    <i class="fas fa-balance-scale text-indigo-600 mr-3"></i>
                    Comparaci√≥n de Escenarios
                </h3>
                <p class="text-indigo-700 mb-6">Compara diferentes estrategias de jubilaci√≥n cambiando la edad de retiro y la tasa de rendimiento</p>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Scenario 1 -->
                    <div class="bg-white rounded-lg p-4 border border-indigo-200">
                        <h4 class="text-lg font-semibold text-indigo-800 mb-3 flex items-center">
                            <i class="fas fa-user-clock text-indigo-600 mr-2"></i>
                            Escenario 1: Jubilaci√≥n Temprana (60 a√±os)
                        </h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-indigo-700">Edad de Jubilaci√≥n:</span>
                                <span class="font-semibold text-indigo-900">60 a√±os</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-indigo-700">A√±os de Retiro:</span>
                                <span class="font-semibold text-indigo-900">{{ (60 - session['cartera_datos']['edad_actual']) if session['cartera_datos'] else 'N/A' }} a√±os</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-indigo-700">TEA Conservadora:</span>
                                <span class="font-semibold text-indigo-900">4.0%</span>
                            </div>
                            <div class="flex justify-between border-t border-indigo-100 pt-2 mt-3">
                                <span class="text-indigo-700 font-medium">Pensi√≥n Mensual Estimada:</span>
                                <span class="font-bold text-indigo-800 text-lg" data-scenario="1">${{ "%.0f"|format(resultado.pension_mensual_neta * 0.85) if resultado else 'N/A' }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Scenario 2 -->
                    <div class="bg-white rounded-lg p-4 border border-purple-200">
                        <h4 class="text-lg font-semibold text-purple-800 mb-3 flex items-center">
                            <i class="fas fa-user-tie text-purple-600 mr-2"></i>
                            Escenario 2: Jubilaci√≥n Est√°ndar (65 a√±os)
                        </h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-purple-700">Edad de Jubilaci√≥n:</span>
                                <span class="font-semibold text-purple-900">65 a√±os</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-purple-700">A√±os de Retiro:</span>
                                <span class="font-semibold text-purple-900">{{ (65 - session['cartera_datos']['edad_actual']) if session['cartera_datos'] else 'N/A' }} a√±os</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-purple-700">TEA Moderada:</span>
                                <span class="font-semibold text-purple-900">6.0%</span>
                            </div>
                            <div class="flex justify-between border-t border-purple-100 pt-2 mt-3">
                                <span class="text-purple-700 font-medium">Pensi√≥n Mensual Estimada:</span>
                                <span class="font-bold text-purple-800 text-lg" data-scenario="2">${{ "%.0f"|format(resultado.pension_mensual_neta * 1.15) if resultado else 'N/A' }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Scenario 3 -->
                    <div class="bg-white rounded-lg p-4 border border-green-200">
                        <h4 class="text-lg font-semibold text-green-800 mb-3 flex items-center">
                            <i class="fas fa-user-shield text-green-600 mr-2"></i>
                            Escenario 3: Jubilaci√≥n Tard√≠a (70 a√±os)
                        </h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-green-700">Edad de Jubilaci√≥n:</span>
                                <span class="font-semibold text-green-900">70 a√±os</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-green-700">A√±os de Retiro:</span>
                                <span class="font-semibold text-green-900">{{ (70 - session['cartera_datos']['edad_actual']) if session['cartera_datos'] else 'N/A' }} a√±os</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-green-700">TEA Agresiva:</span>
                                <span class="font-semibold text-green-900">8.0%</span>
                            </div>
                            <div class="flex justify-between border-t border-green-100 pt-2 mt-3">
                                <span class="text-green-700 font-medium">Pensi√≥n Mensual Estimada:</span>
                                <span class="font-bold text-green-800 text-lg" data-scenario="3">${{ "%.0f"|format(resultado.pension_mensual_neta * 1.4) if resultado else 'N/A' }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Scenario -->
                    <div class="bg-white rounded-lg p-4 border border-orange-200">
                        <h4 class="text-lg font-semibold text-orange-800 mb-3 flex items-center">
                            <i class="fas fa-sliders-h text-orange-600 mr-2"></i>
                            Escenario Personalizado
                        </h4>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-medium text-orange-700 mb-1">Edad de Jubilaci√≥n</label>
                                <input type="number" id="custom-edad" class="w-full px-2 py-1 text-sm border border-orange-300 rounded focus:ring-1 focus:ring-orange-500" placeholder="67" min="50" max="80">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-orange-700 mb-1">TEA Personalizada (%)</label>
                                <input type="number" id="custom-tea" class="w-full px-2 py-1 text-sm border border-orange-300 rounded focus:ring-1 focus:ring-orange-500" placeholder="5.5" min="0" max="15" step="0.1">
                            </div>
                            <button id="calcular-personalizado" class="w-full bg-orange-600 text-white px-3 py-2 rounded text-sm hover:bg-orange-700 transition-colors">
                                <i class="fas fa-calculator mr-1"></i>Calcular
                            </button>
                            <div class="border-t border-orange-100 pt-2 mt-3">
                                <div class="flex justify-between text-sm">
                                    <span class="text-orange-700 font-medium">Pensi√≥n Estimada:</span>
                                    <span class="font-bold text-orange-800" id="custom-result">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 bg-indigo-100 border border-indigo-300 rounded-lg p-4">
                    <div class="flex items-start">
                        <i class="fas fa-lightbulb text-indigo-600 mr-3 mt-1"></i>
                        <div>
                            <h5 class="font-semibold text-indigo-800 mb-1">üí° Consejos para Comparar Escenarios</h5>
                            <ul class="text-sm text-indigo-700 space-y-1">
                                <li>‚Ä¢ <strong>Jubilaci√≥n temprana:</strong> Requiere mayor capital inicial y TEA m√°s conservadora</li>
                                <li>‚Ä¢ <strong>Jubilaci√≥n tard√≠a:</strong> Permite acumular m√°s capital pero menos a√±os de retiro</li>
                                <li>‚Ä¢ <strong>TEA m√°s alta:</strong> Aumenta el riesgo pero tambi√©n el potencial de ingresos</li>
                                <li>‚Ä¢ <strong>Considera:</strong> Inflaci√≥n, salud y cambios en el mercado laboral</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <a href="{{ url_for('main.descargar_pdf', modulo='jubilacion') }}"
                   class="inline-flex items-center justify-center bg-secondary-600 text-white px-8 py-4 rounded-xl hover:bg-secondary-700 transition-all duration-200 font-semibold shadow-lg hover:shadow-xl no-underline">
                    <i class="fas fa-download mr-3"></i>
                    Descargar Reporte PDF
                </a>
                <a href="{{ url_for('main.bonos') }}"
                   class="inline-flex items-center justify-center bg-purple-600 text-white px-8 py-4 rounded-xl hover:bg-purple-700 transition-all duration-200 font-semibold shadow-lg hover:shadow-xl">
                    <span>Continuar a Bonos</span>
                    <i class="fas fa-arrow-right ml-3"></i>
                </a>
            </div>
        </div>
    {% endif %}
</div>

{% block scripts %}
<script>
    // Global variables from server
    const CAPITAL_FINAL = {{ session['cartera_resumen']['capital_final'] if session['cartera_resumen'] else 0 | tojson }};
    const BASE_PENSION_VALUE = {{ resultado.pension_mensual_neta if resultado else 0 | tojson }};
    const EDAD_ACTUAL_VALUE = {{ session['cartera_datos']['edad_actual'] if session['cartera_datos'] else 30 | tojson }};

    // Help tooltip functionality
    function showHelpTooltip(message, element) {
        // Remove existing tooltips
        const existingTooltip = document.querySelector('.help-tooltip');
        if (existingTooltip) {
            existingTooltip.remove();
        }

        // Create tooltip
        const tooltip = document.createElement('div');
        tooltip.className = 'help-tooltip fixed bg-gray-900 text-white px-4 py-3 rounded-lg shadow-lg z-50 max-w-xs text-sm';
        tooltip.innerHTML = `
            <div class="flex items-start">
                <div class="flex-1">${message}</div>
                <button type="button" class="ml-2 text-gray-400 hover:text-white" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-times text-xs"></i>
                </button>
            </div>
        `;

        // Position tooltip above the button
        const rect = element.getBoundingClientRect();
        const tooltipRect = tooltip.getBoundingClientRect();
        tooltip.style.left = (rect.left + rect.width / 2 - tooltip.offsetWidth / 2) + 'px';
        tooltip.style.top = (rect.top - tooltip.offsetHeight - 10) + 'px';

        // Add to body
        document.body.appendChild(tooltip);

        // Force recalculation for proper positioning
        const actualRect = tooltip.getBoundingClientRect();
        tooltip.style.left = (rect.left + rect.width / 2 - actualRect.width / 2) + 'px';
        tooltip.style.top = (rect.top - actualRect.height - 10) + 'px';

        // Add click outside listener to close tooltip
        function closeTooltipOnClickOutside(event) {
            if (!tooltip.contains(event.target) && !element.contains(event.target)) {
                tooltip.remove();
                document.removeEventListener('click', closeTooltipOnClickOutside);
            }
        }

        // Add listener after a short delay to avoid immediate closing
        setTimeout(() => {
            document.addEventListener('click', closeTooltipOnClickOutside);
        }, 10);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (tooltip.parentElement) {
                tooltip.remove();
                document.removeEventListener('click', closeTooltipOnClickOutside);
            }
        }, 5000);
    }

    // Help button event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Add event listeners to all help buttons
        const helpButtons = document.querySelectorAll('.help-btn');
        helpButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const helpText = this.getAttribute('data-help');
                if (helpText) {
                    showHelpTooltip(helpText, this);
                }
            });
        });
    });

    // Toggle TEA field
    const usarTeaCheckbox = document.getElementById('usar_misma_tea');
    const teaField = document.getElementById('tea_retiro_field');

    if (usarTeaCheckbox) {
        usarTeaCheckbox.addEventListener('change', function() {
            teaField.style.display = this.checked ? 'none' : 'block';
        });
    }

    // Handle retirement type changes - show/hide fields only
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Setting up retirement type change listeners');

        document.querySelectorAll('input[name="tipo_retiro"]').forEach(radio => {
            radio.addEventListener('change', function(e) {
                const tipoRetiro = this.value;
                console.log('Tipo de retiro changed to:', tipoRetiro);

                // Show a√±os retiro field only for pension
                const a√±osField = document.getElementById('a√±os_retiro_field');
                if (a√±osField) {
                    a√±osField.style.display = tipoRetiro === 'pension' ? 'block' : 'none';
                }
            });
        });

        console.log('Retirement type listeners set up');
    });



    // Form submission with AJAX - no page reload
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        console.log('Form found:', form);

        if (form) {
            form.addEventListener('submit', async function(e) {
                e.preventDefault(); // Prevent normal form submission
                console.log('Form submitted via AJAX');

                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;

                // Show loading state
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Calculando...';

                try {
                    // Send form data via AJAX
                    const formData = new FormData(form);
                    const response = await fetch(window.location.pathname, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log('Response received:', data);

                        if (data.success && data.resultado) {
                            // Update results section with the received data
                            updateJubilacionResults(data.resultado, data.modulo_a_completado);

                            // Scroll to results
                            const resultsSection = document.getElementById('results-section');
                            if (resultsSection) {
                                resultsSection.scrollIntoView({ behavior: 'smooth' });
                            }
                        } else {
                            console.error('Calculation failed:', data.error);
                            showError(data.error || 'Error al calcular. Por favor intenta nuevamente.');
                        }
                    } else {
                        console.error('Form submission failed');
                        showError('Error al calcular. Por favor intenta nuevamente.');
                    }
                } catch (error) {
                    console.error('AJAX error:', error);
                    showError('Error de conexi√≥n. Por favor verifica tu conexi√≥n a internet.');
                } finally {
                    // Restore button state
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }

                return false;
            });
        } else {
            console.error('Form not found!');
        }
    });

    // Function to re-initialize JavaScript after page update
    function initializeAfterUpdate() {
        console.log('Re-initializing JavaScript after update');

        // Re-setup help buttons
        const helpButtons = document.querySelectorAll('.help-btn');
        helpButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const helpText = this.getAttribute('data-help');
                if (helpText) {
                    showHelpTooltip(helpText, this);
                }
            });
        });

        // Re-setup retirement type listeners
        document.querySelectorAll('input[name="tipo_retiro"]').forEach(radio => {
            radio.addEventListener('change', function(e) {
                const tipoRetiro = this.value;
                console.log('Tipo de retiro changed to:', tipoRetiro);

                // Show a√±os retiro field only for pension
                const a√±osField = document.getElementById('a√±os_retiro_field');
                if (a√±osField) {
                    a√±osField.style.display = tipoRetiro === 'pension' ? 'block' : 'none';
                }
            });
        });

        // Re-setup TEA checkbox
        const usarTeaCheckbox = document.getElementById('usar_misma_tea');
        const teaField = document.getElementById('tea_retiro_field');
        if (usarTeaCheckbox) {
            usarTeaCheckbox.addEventListener('change', function() {
                teaField.style.display = this.checked ? 'none' : 'block';
            });
        }

        // Re-setup custom scenario calculator
        document.getElementById('calcular-personalizado')?.addEventListener('click', function() {
            const edadInput = document.getElementById('custom-edad');
            const teaInput = document.getElementById('custom-tea');
            const resultElement = document.getElementById('custom-result');

            const edadJubilacion = parseInt(edadInput.value);
            const teaPersonalizada = parseFloat(teaInput.value);

            if (!edadJubilacion || !teaPersonalizada || edadJubilacion < 50 || edadJubilacion > 80) {
                resultElement.textContent = 'Datos inv√°lidos';
                resultElement.style.color = '#dc2626';
                return;
            }

            // Simple estimation based on current results
            const basePension = BASE_PENSION_VALUE;
            const edadActual = EDAD_ACTUAL_VALUE;
            const a√±osRetiro = Math.max(1, edadJubilacion - edadActual);

            // Adjust pension based on retirement age and TEA
            let factor = 1;
            if (edadJubilacion < 65) {
                factor = 0.8; // Earlier retirement reduces pension
            } else if (edadJubilacion > 65) {
                factor = 1.2; // Later retirement increases pension
            }

            // Adjust for TEA difference (assuming base is 5%)
            const baseTea = 5.0;
            const teaAdjustment = (teaPersonalizada - baseTea) / 100;
            factor *= (1 + teaAdjustment);

            const estimatedPension = Math.round(basePension * factor);
            resultElement.textContent = '$' + estimatedPension.toLocaleString();
            resultElement.style.color = '#ea580c';
        });
    }

    // Custom scenario calculation
    document.getElementById('calcular-personalizado')?.addEventListener('click', function() {
        const edadInput = document.getElementById('custom-edad');
        const teaInput = document.getElementById('custom-tea');
        const resultElement = document.getElementById('custom-result');

        const edadJubilacion = parseInt(edadInput.value);
        const teaPersonalizada = parseFloat(teaInput.value);

        if (!edadJubilacion || !teaPersonalizada || edadJubilacion < 50 || edadJubilacion > 80) {
            resultElement.textContent = 'Datos inv√°lidos';
            resultElement.style.color = '#dc2626';
            return;
        }

        // Simple estimation based on current results
        const basePension = BASE_PENSION_VALUE;
        const edadActual = EDAD_ACTUAL_VALUE;
        const a√±osRetiro = Math.max(1, edadJubilacion - edadActual);

        // Adjust pension based on retirement age and TEA
        let factor = 1;
        if (edadJubilacion < 65) {
            factor = 0.8; // Earlier retirement reduces pension
        } else if (edadJubilacion > 65) {
            factor = 1.2; // Later retirement increases pension
        }

        // Adjust for TEA difference (assuming base is 5%)
        const baseTea = 5.0;
        const teaAdjustment = (teaPersonalizada - baseTea) / 100;
        factor *= (1 + teaAdjustment);

        const estimatedPension = Math.round(basePension * factor);
        resultElement.textContent = '$' + estimatedPension.toLocaleString();
        resultElement.style.color = '#ea580c';
    });

    function updateJubilacionResults(resultado, moduloACompletado) {
        console.log('Updating results with:', resultado);

        // Remove existing results section
        const existingResults = document.getElementById('results-section');
        if (existingResults) {
            existingResults.remove();
        }

        // Generate results HTML
        const resultsHTML = `
            <div class="space-y-8" id="results-section">
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl border border-blue-200 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-info-circle text-blue-600 text-xl"></i>
                            </div>
                            <span class="text-xs font-medium text-blue-600 bg-blue-100 px-2 py-1 rounded-full">GENERAL</span>
                        </div>
                        <div class="text-2xl font-bold text-blue-900 mb-1">
                            ${resultado.tipo_retiro === 'pension' ? 'Pensi√≥n' : resultado.tipo_retiro === 'dividendos' ? 'Dividendos' : 'Retiro'}
                        </div>
                        <div class="text-sm text-blue-700 font-medium">Tipo de Retiro</div>
                    </div>

                    <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-xl border border-green-200 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-dollar-sign text-green-600 text-xl"></i>
                            </div>
                            <span class="text-xs font-medium text-green-600 bg-green-100 px-2 py-1 rounded-full">MENSUAL</span>
                        </div>
                        <div class="text-2xl font-bold text-green-900 mb-1">$` + resultado.pension_mensual_neta.toFixed(2) + `</div>
                        <div class="text-sm text-green-700 font-medium">Pensi√≥n Neta</div>
                    </div>

                    <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 p-6 rounded-xl border border-yellow-200 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-calendar text-yellow-600 text-xl"></i>
                            </div>
                            <span class="text-xs font-medium text-yellow-600 bg-yellow-100 px-2 py-1 rounded-full">EDAD</span>
                        </div>
                        <div class="text-2xl font-bold text-yellow-900 mb-1">${resultado.edad_jubilacion || 'N/A'}</div>
                        <div class="text-sm text-yellow-700 font-medium">Edad de Jubilaci√≥n</div>
                    </div>

                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-xl border border-purple-200 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-percentage text-purple-600 text-xl"></i>
                            </div>
                            <span class="text-xs font-medium text-purple-600 bg-purple-100 px-2 py-1 rounded-full">TEA</span>
                        </div>
                        <div class="text-2xl font-bold text-purple-900 mb-1">${resultado.tea_retiro.toFixed(1)}%</div>
                        <div class="text-sm text-purple-700 font-medium">Tasa de Retiro</div>
                    </div>
                </div>

                <!-- Detailed Results -->
                <div class="bg-white rounded-2xl shadow-xl border border-secondary-200 overflow-hidden">
                    <div class="bg-secondary-50 px-8 py-6 border-b border-secondary-200">
                        <h3 class="text-2xl font-bold text-secondary-900 flex items-center">
                            <i class="fas fa-chart-bar text-green-600 mr-3"></i>
                            Detalles de la Proyecci√≥n
                        </h3>
                        <p class="text-secondary-600 mt-2">Resumen completo de tu jubilaci√≥n proyectada</p>
                    </div>
                    <div class="p-8">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Informaci√≥n General -->
                            <div class="bg-blue-50 border border-blue-200 rounded-xl p-6">
                                <h4 class="text-lg font-semibold text-blue-800 mb-4 flex items-center">
                                    <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                                    Informaci√≥n General
                                </h4>
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between items-center py-2 border-b border-blue-100">
                                        <span class="text-blue-700 font-medium">Tipo de Retiro:</span>
                                        <span class="font-semibold text-blue-900" data-field="tipo_retiro">
                                            ${resultado.tipo_retiro === 'pension' ? 'Pensi√≥n Mensual' : resultado.tipo_retiro === 'dividendos' ? 'Renta v√≠a Dividendos' : 'Retiro Total'}
                                        </span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-blue-100">
                                        <span class="text-blue-700 font-medium">Tipo de Impuesto:</span>
                                        <span class="font-semibold text-blue-900">${resultado.tipo_impuesto.charAt(0).toUpperCase() + resultado.tipo_impuesto.slice(1)}</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-blue-100">
                                        <span class="text-blue-700 font-medium">Capital Inicial:</span>
                                        <span class="font-semibold text-blue-900">$${resultado.capital_inicial.toFixed(2)}</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-blue-100">
                                        <span class="text-blue-700 font-medium">Ingresos Adicionales:</span>
                                        <span class="font-semibold text-blue-900">$${resultado.ingresos_adicionales.toFixed(2)}/mes</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2">
                                        <span class="text-blue-700 font-medium">TEA de Retiro:</span>
                                        <span class="font-semibold text-blue-900">${resultado.tea_retiro.toFixed(2)}%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Resumen Financiero -->
                            <div class="bg-green-50 border border-green-200 rounded-xl p-6">
                                <h4 class="text-lg font-semibold text-green-800 mb-4 flex items-center">
                                    <i class="fas fa-dollar-sign text-green-600 mr-2"></i>
                                    Resumen Financiero
                                </h4>
                                <div class="space-y-3 text-sm">
                                    ${resultado.tipo_retiro === 'pension' ? `
                                    <div class="flex justify-between items-center py-2 border-b border-green-100">
                                        <span class="text-green-700 font-medium">Pensi√≥n Mensual Bruta:</span>
                                        <span class="font-semibold text-green-900" data-field="pension_bruta">$${resultado.pension_mensual_bruta.toFixed(2)}</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-green-100">
                                        <span class="text-green-700 font-medium">Impuesto Mensual:</span>
                                        <span class="font-semibold text-red-600" data-field="impuesto">$${resultado.impuesto_mensual.toFixed(2)}</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2">
                                        <span class="text-green-700 font-medium">Pensi√≥n Mensual Neta:</span>
                                        <span class="font-bold text-green-800 text-lg" data-field="pension_neta">$${resultado.pension_mensual_neta.toFixed(2)}</span>
                                    </div>
                                    ` : `
                                    <div class="flex justify-between items-center py-2 border-b border-green-100">
                                        <span class="text-green-700 font-medium">Retiro Total Bruto:</span>
                                        <span class="font-semibold text-green-900" data-field="pension_bruta">$${resultado.pension_mensual_bruta.toFixed(2)}</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-green-100">
                                        <span class="text-green-700 font-medium">Impuesto Total:</span>
                                        <span class="font-semibold text-red-600" data-field="impuesto">$${resultado.impuesto_mensual.toFixed(2)}</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2">
                                        <span class="text-green-700 font-medium">Retiro Total Neto:</span>
                                        <span class="font-bold text-green-800 text-lg" data-field="pension_neta">$${resultado.pension_mensual_neta.toFixed(2)}</span>
                                    </div>
                                    `}
                                </div>
                            </div>
                        </div>

                        <!-- Annual Projection (only for pension) -->
                        ${resultado.tipo_retiro === 'pension' ? `
                        <div class="mt-8 bg-yellow-50 border border-yellow-200 rounded-xl p-6">
                            <h4 class="text-lg font-semibold text-yellow-800 mb-4 flex items-center">
                                <i class="fas fa-calendar text-yellow-600 mr-2"></i>
                                Proyecci√≥n Anual
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="text-center">
                                    <div class="text-3xl font-bold text-yellow-800 mb-2">$${resultado.pension_anual_bruta.toFixed(2)}</div>
                                    <div class="text-sm text-yellow-700 font-medium">Ingreso Bruto Anual</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-3xl font-bold text-red-600 mb-2">$${resultado.impuesto_anual.toFixed(2)}</div>
                                    <div class="text-sm text-yellow-700 font-medium">Impuestos Anuales</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-3xl font-bold text-green-800 mb-2">$${resultado.pension_anual_neta.toFixed(2)}</div>
                                    <div class="text-sm text-yellow-700 font-medium">Ingreso Neto Anual</div>
                                </div>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Calculation Details -->
                        <div class="mt-6 bg-blue-50 border border-blue-200 rounded-xl p-6">
                            <h4 class="text-lg font-semibold text-blue-800 mb-4 flex items-center">
                                <i class="fas fa-calculator text-blue-600 mr-2"></i>
                                Detalles del C√°lculo
                            </h4>
                            <div class="space-y-4">
                                ${resultado.tipo_retiro === 'pension' ? `
                                <div class="bg-white rounded-lg p-4 border border-blue-200">
                                    <h5 class="font-semibold text-blue-900 mb-2">üìä Pensi√≥n Mensual</h5>
                                    <div class="text-sm text-blue-700 space-y-1">
                                        <p><strong>F√≥rmula:</strong> Capital Final √∑ (A√±os de Retiro √ó 12)</p>
                                        <p><strong>Datos utilizados:</strong></p>
                                        <ul class="list-disc list-inside ml-4 space-y-1">
                                            <li>Capital Final: $${resultado.capital_inicial.toFixed(2)} (de M√≥dulo A)</li>
                                            <li>A√±os de Retiro: ${Math.max(1, Math.floor((resultado.edad_jubilacion - EDAD_ACTUAL_VALUE) || 10))} a√±os</li>
                                            <li>TEA de Retiro: ${resultado.tea_retiro.toFixed(2)}% (con ajuste por compounding)</li>
                                            <li>Impuesto: ${resultado.tipo_impuesto === 'extranjera' ? '29.5%' : '5%'} sobre ingresos</li>
                                        </ul>
                                        <p class="mt-2"><strong>Resultado:</strong> $${resultado.pension_mensual_neta.toFixed(2)} mensuales (neto de impuestos)</p>
                                    </div>
                                </div>
                                ` : resultado.tipo_retiro === 'dividendos' ? `
                                <div class="bg-white rounded-lg p-4 border border-blue-200">
                                    <h5 class="font-semibold text-blue-900 mb-3">üí∞ Renta v√≠a Dividendos</h5>

                                    <div class="mb-4">
                                        <h6 class="font-medium text-blue-800 mb-2">C√°lculo paso a paso</h6>
                                        <div class="space-y-2 text-sm text-blue-700">
                                            <div class="bg-blue-50 p-2 rounded">
                                                <strong>1. Obtener capital acumulado final</strong><br>
                                                Capital Final = $${resultado.capital_inicial.toFixed(2)} (saldo total acumulado al momento de la jubilaci√≥n, despu√©s de aportes e intereses)
                                            </div>

                                            <div class="bg-blue-50 p-2 rounded">
                                                <strong>2. Determinar TEA para dividendos</strong><br>
                                                TEA de Retiro = ${resultado.tea_retiro.toFixed(2)}% (tasa efectiva anual durante el retiro)
                                            </div>

                                            <div class="bg-blue-50 p-2 rounded">
                                                <strong>3. Calcular dividendos anuales</strong><br>
                                                Dividendos Anuales = Capital Final √ó (TEA √∑ 2)<br>
                                                Dividendos Anuales = $${resultado.capital_inicial.toFixed(2)} √ó (${resultado.tea_retiro.toFixed(2)}% √∑ 2)<br>
                                                Dividendos Anuales = $${resultado.capital_inicial.toFixed(2)} √ó ${(resultado.tea_retiro / 2).toFixed(4)}<br>
                                                Dividendos Anuales = $${(resultado.capital_inicial * (resultado.tea_retiro / 100) / 2).toFixed(2)}
                                            </div>

                                            <div class="bg-blue-50 p-2 rounded">
                                                <strong>4. Convertir dividendos anuales a mensuales</strong><br>
                                                Dividendos Mensuales = Dividendos Anuales √∑ 12<br>
                                                Dividendos Mensuales = $${(resultado.capital_inicial * (resultado.tea_retiro / 100) / 2).toFixed(2)} √∑ 12<br>
                                                Dividendos Mensuales = $${resultado.pension_mensual_bruta.toFixed(2)}
                                            </div>

                                            <div class="bg-blue-50 p-2 rounded">
                                                <strong>5. Calcular impuesto mensual sobre dividendos</strong><br>
                                                Tasa de Impuesto = ${resultado.tipo_impuesto === 'extranjera' ? '29.5%' : '5%'} (sobre dividendos)<br>
                                                Impuesto Mensual = Dividendos Mensuales √ó Tasa de Impuesto<br>
                                                Impuesto Mensual = $${resultado.pension_mensual_bruta.toFixed(2)} √ó ${resultado.tipo_impuesto === 'extranjera' ? '0.295' : '0.05'}<br>
                                                Impuesto Mensual = $${resultado.impuesto_mensual.toFixed(2)}
                                            </div>

                                            <div class="bg-blue-50 p-2 rounded">
                                                <strong>6. Calcular ingreso neto mensual</strong><br>
                                                Ingreso Neto Mensual = Dividendos Mensuales - Impuesto Mensual<br>
                                                Ingreso Neto Mensual = $${resultado.pension_mensual_bruta.toFixed(2)} - $${resultado.impuesto_mensual.toFixed(2)}<br>
                                                Ingreso Neto Mensual = $${resultado.pension_mensual_neta.toFixed(2)}
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-4">
                                        <h6 class="font-medium text-blue-800 mb-2">Resumen de datos utilizados</h6>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                            <div class="bg-green-50 p-3 rounded border border-green-200">
                                                <h7 class="font-semibold text-green-800 mb-2">Datos de Entrada</h7>
                                                <ul class="space-y-1 text-green-700">
                                                    <li><strong>Capital Final:</strong> $${resultado.capital_inicial.toFixed(2)}</li>
                                                    <li><strong>TEA de Retiro:</strong> ${resultado.tea_retiro.toFixed(2)}%</li>
                                                    <li><strong>Tipo de Impuesto:</strong> ${resultado.tipo_impuesto === 'extranjera' ? 'Fuente Extranjera (29.5%)' : 'Bolsa Local (5%)'}</li>
                                                    <li><strong>Edad de Jubilaci√≥n:</strong> ${resultado.edad_jubilacion || 'N/A'} a√±os</li>
                                                </ul>
                                            </div>

                                            <div class="bg-purple-50 p-3 rounded border border-purple-200">
                                                <h7 class="font-semibold text-purple-800 mb-2">Resultados del C√°lculo</h7>
                                                <ul class="space-y-1 text-purple-700">
                                                    <li><strong>Dividendos Anuales:</strong> $${(resultado.capital_inicial * (resultado.tea_retiro / 100) / 2).toFixed(2)}</li>
                                                    <li><strong>Dividendos Mensuales Brutos:</strong> $${resultado.pension_mensual_bruta.toFixed(2)}</li>
                                                    <li><strong>Impuesto Mensual:</strong> $${resultado.impuesto_mensual.toFixed(2)}</li>
                                                    <li><strong>Ingreso Neto Mensual:</strong> $${resultado.pension_mensual_neta.toFixed(2)}</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="bg-green-50 p-3 rounded border border-green-200">
                                        <p class="text-sm"><strong>Resultado final:</strong> $${resultado.pension_mensual_neta.toFixed(2)} mensuales (neto de impuestos)</p>
                                        <p class="text-xs text-green-600 mt-1">* El capital principal se mantiene intacto, solo se retiran los dividendos generados</p>
                                    </div>
                                </div>
                                ` : `
                                <div class="bg-white rounded-lg p-4 border border-blue-200">
                                    <h5 class="font-semibold text-blue-900 mb-3">üíµ Cobro Total (Retiro √önico)</h5>

                                    <div class="mb-4">
                                        <h6 class="font-medium text-blue-800 mb-2">Definici√≥n</h6>
                                        <p class="text-sm text-blue-700">Es una modalidad de jubilaci√≥n en la que el usuario retira todo el monto acumulado (capital m√°s intereses) en un solo pago al cumplir la edad de jubilaci√≥n.</p>
                                    </div>

                                    <div class="mb-4">
                                        <h6 class="font-medium text-blue-800 mb-2">C√°lculo paso a paso</h6>
                                        <div class="space-y-2 text-sm text-blue-700">
                                            <div class="bg-blue-50 p-2 rounded">
                                                <strong>1. Determinar el saldo acumulado (Ingreso final)</strong><br>
                                                Se obtiene al finalizar el periodo de aportes e inversi√≥n, justo en la edad de jubilaci√≥n elegida.<br>
                                                <em>Este saldo incluye el aporte inicial, todos los aportes peri√≥dicos y el inter√©s compuesto generado seg√∫n la TEA y el plazo de ahorro.</em>
                                            </div>

                                            <div class="bg-blue-50 p-2 rounded">
                                                <strong>2. Calcular los "Costos" (Aportes totales)</strong><br>
                                                Es la suma literal de todos los aportes realizados por el usuario:<br>
                                                <strong>Aportes totales = Aporte inicial + ‚àëAportes peri√≥dicos</strong><br>
                                                <em>No se consideran comisiones ni gastos administrativos, solo el dinero aportado.</em>
                                            </div>

                                            <div class="bg-blue-50 p-2 rounded">
                                                <strong>3. Obtener la ganancia neta (Renta)</strong><br>
                                                Renta es la diferencia entre el saldo acumulado y los aportes totales:<br>
                                                <strong>Renta = Saldo acumulado - Aportes totales</strong><br>
                                                <em>Es el monto sobre el cual se debe aplicar el impuesto.</em>
                                            </div>

                                            <div class="bg-blue-50 p-2 rounded">
                                                <strong>4. Aplicar impuesto sobre la renta</strong><br>
                                                Se determina si corresponde 29.5% (fuente extranjera) o 5% (fuente local, dividendos) y se aplica a la ganancia neta:<br>
                                                <strong>Impuesto jubilaci√≥n = Renta √ó Tasa de impuesto</strong>
                                            </div>

                                            <div class="bg-blue-50 p-2 rounded">
                                                <strong>5. Calcular el monto neto a retirar</strong><br>
                                                El monto neto que el usuario recibe es:<br>
                                                <strong>Monto neto = Saldo acumulado - Impuesto jubilaci√≥n</strong><br>
                                                <em>Es el dinero realmente disponible tras impuestos.</em>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-4">
                                        <h6 class="font-medium text-blue-800 mb-2">Datos utilizados en el c√°lculo</h6>
                                        <ul class="list-disc list-inside ml-4 space-y-1 text-sm text-blue-700">
                                            <li><strong>Saldo acumulado:</strong> $${resultado.capital_inicial.toFixed(2)} (capital final de M√≥dulo A)</li>
                                            <li><strong>Aportes totales:</strong> Calculados desde M√≥dulo A (aporte inicial + aportes peri√≥dicos)</li>
                                            <li><strong>Renta (ganancia):</strong> Diferencia entre saldo acumulado y aportes totales</li>
                                            <li><strong>Tasa de impuesto:</strong> ${resultado.tipo_impuesto === 'extranjera' ? '29.5%' : '5%'} sobre la renta</li>
                                            <li><strong>TEA:</strong> ${resultado.tea_retiro.toFixed(2)}% (no se convierte, se usa directamente)</li>
                                        </ul>
                                    </div>

                                    <div class="bg-green-50 p-3 rounded border border-green-200">
                                        <p class="text-sm"><strong>Resultado final:</strong> $${resultado.pension_mensual_neta.toFixed(2)} en un solo pago (neto de impuestos)</p>
                                    </div>

                                    <div class="mt-3">
                                        <h6 class="font-medium text-blue-800 mb-2">Caracter√≠sticas adicionales</h6>
                                        <ul class="text-xs text-blue-600 space-y-1">
                                            <li>‚Ä¢ No se necesita convertir la TEA (se usa tal cual, porque el saldo se proyecta directamente hasta la edad de jubilaci√≥n)</li>
                                            <li>‚Ä¢ El retiro es √∫nico, no hay pagos peri√≥dicos ni c√°lculo de pensi√≥n mensual</li>
                                            <li>‚Ä¢ Todo el capital acumulado se retira en un √∫nico pago tras deducir impuestos</li>
                                        </ul>
                                    </div>
                                </div>
                                `}
                            </div>
                        </div>

                        <!-- Success Message -->
                        <div class="mt-6 bg-green-50 border border-green-200 rounded-xl p-4">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-600 mr-3"></i>
                                <div>
                                    <strong class="text-green-800">${resultado.mensaje}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Scenario Comparison -->
                <div class="bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200 rounded-xl p-6">
                    <h3 class="text-xl font-bold text-indigo-900 mb-4 flex items-center">
                        <i class="fas fa-balance-scale text-indigo-600 mr-3"></i>
                        Comparaci√≥n de Escenarios
                    </h3>
                    <p class="text-indigo-700 mb-6">Compara diferentes estrategias de jubilaci√≥n cambiando la edad de retiro y la tasa de rendimiento</p>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Scenario 1 -->
                        <div class="bg-white rounded-lg p-4 border border-indigo-200">
                            <h4 class="text-lg font-semibold text-indigo-800 mb-3 flex items-center">
                                <i class="fas fa-user-clock text-indigo-600 mr-2"></i>
                                Escenario 1: Jubilaci√≥n Temprana (60 a√±os)
                            </h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-indigo-700">Edad de Jubilaci√≥n:</span>
                                    <span class="font-semibold text-indigo-900">60 a√±os</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-indigo-700">A√±os de Retiro:</span>
                                    <span class="font-semibold text-indigo-900">${EDAD_ACTUAL_VALUE ? (60 - EDAD_ACTUAL_VALUE) : 'N/A'} a√±os</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-indigo-700">TEA Conservadora:</span>
                                    <span class="font-semibold text-indigo-900">4.0%</span>
                                </div>
                                <div class="flex justify-between border-t border-indigo-100 pt-2 mt-3">
                                    <span class="text-indigo-700 font-medium">Pensi√≥n Mensual Estimada:</span>
                                    <span class="font-bold text-indigo-800 text-lg" data-scenario="1">$${Math.round(resultado.pension_mensual_neta * 0.85)}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Scenario 2 -->
                        <div class="bg-white rounded-lg p-4 border border-purple-200">
                            <h4 class="text-lg font-semibold text-purple-800 mb-3 flex items-center">
                                <i class="fas fa-user-tie text-purple-600 mr-2"></i>
                                Escenario 2: Jubilaci√≥n Est√°ndar (65 a√±os)
                            </h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-purple-700">Edad de Jubilaci√≥n:</span>
                                    <span class="font-semibold text-purple-900">65 a√±os</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-purple-700">A√±os de Retiro:</span>
                                    <span class="font-semibold text-purple-900">${EDAD_ACTUAL_VALUE ? (65 - EDAD_ACTUAL_VALUE) : 'N/A'} a√±os</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-purple-700">TEA Moderada:</span>
                                    <span class="font-semibold text-purple-900">6.0%</span>
                                </div>
                                <div class="flex justify-between border-t border-purple-100 pt-2 mt-3">
                                    <span class="text-purple-700 font-medium">Pensi√≥n Mensual Estimada:</span>
                                    <span class="font-bold text-purple-800 text-lg" data-scenario="2">$${Math.round(resultado.pension_mensual_neta * 1.15)}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Scenario 3 -->
                        <div class="bg-white rounded-lg p-4 border border-green-200">
                            <h4 class="text-lg font-semibold text-green-800 mb-3 flex items-center">
                                <i class="fas fa-user-shield text-green-600 mr-2"></i>
                                Escenario 3: Jubilaci√≥n Tard√≠a (70 a√±os)
                            </h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-green-700">Edad de Jubilaci√≥n:</span>
                                    <span class="font-semibold text-green-900">70 a√±os</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-green-700">A√±os de Retiro:</span>
                                    <span class="font-semibold text-green-900">${EDAD_ACTUAL_VALUE ? (70 - EDAD_ACTUAL_VALUE) : 'N/A'} a√±os</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-green-700">TEA Agresiva:</span>
                                    <span class="font-semibold text-green-900">8.0%</span>
                                </div>
                                <div class="flex justify-between border-t border-green-100 pt-2 mt-3">
                                    <span class="text-green-700 font-medium">Pensi√≥n Mensual Estimada:</span>
                                    <span class="font-bold text-green-800 text-lg" data-scenario="3">$${Math.round(resultado.pension_mensual_neta * 1.4)}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Custom Scenario -->
                        <div class="bg-white rounded-lg p-4 border border-orange-200">
                            <h4 class="text-lg font-semibold text-orange-800 mb-3 flex items-center">
                                <i class="fas fa-sliders-h text-orange-600 mr-2"></i>
                                Escenario Personalizado
                            </h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-xs font-medium text-orange-700 mb-1">Edad de Jubilaci√≥n</label>
                                    <input type="number" id="custom-edad" class="w-full px-2 py-1 text-sm border border-orange-300 rounded focus:ring-1 focus:ring-orange-500" placeholder="67" min="50" max="80">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-orange-700 mb-1">TEA Personalizada (%)</label>
                                    <input type="number" id="custom-tea" class="w-full px-2 py-1 text-sm border border-orange-300 rounded focus:ring-1 focus:ring-orange-500" placeholder="5.5" min="0" max="15" step="0.1">
                                </div>
                                <button id="calcular-personalizado" class="w-full bg-orange-600 text-white px-3 py-2 rounded text-sm hover:bg-orange-700 transition-colors">
                                    <i class="fas fa-calculator mr-1"></i>Calcular
                                </button>
                                <div class="border-t border-orange-100 pt-2 mt-3">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-orange-700 font-medium">Pensi√≥n Estimada:</span>
                                        <span class="font-bold text-orange-800" id="custom-result">$0.00</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 bg-indigo-100 border border-indigo-300 rounded-lg p-4">
                        <div class="flex items-start">
                            <i class="fas fa-lightbulb text-indigo-600 mr-3 mt-1"></i>
                            <div>
                                <h5 class="font-semibold text-indigo-800 mb-1">üí° Consejos para Comparar Escenarios</h5>
                                <ul class="text-sm text-indigo-700 space-y-1">
                                    <li>‚Ä¢ <strong>Jubilaci√≥n temprana:</strong> Requiere mayor capital inicial y TEA m√°s conservadora</li>
                                    <li>‚Ä¢ <strong>Jubilaci√≥n tard√≠a:</strong> Permite acumular m√°s capital pero menos a√±os de retiro</li>
                                    <li>‚Ä¢ <strong>TEA m√°s alta:</strong> Aumenta el riesgo pero tambi√©n el potencial de ingresos</li>
                                    <li>‚Ä¢ <strong>Considera:</strong> Inflaci√≥n, salud y cambios en el mercado laboral</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <a href="/descargar-pdf/jubilacion"
                       class="inline-flex items-center justify-center bg-secondary-600 text-white px-8 py-4 rounded-xl hover:bg-secondary-700 transition-all duration-200 font-semibold shadow-lg hover:shadow-xl no-underline">
                        <i class="fas fa-download mr-3"></i>
                        Descargar Reporte PDF
                    </a>
                    <a href="/bonos"
                       class="inline-flex items-center justify-center bg-purple-600 text-white px-8 py-4 rounded-xl hover:bg-purple-700 transition-all duration-200 font-semibold shadow-lg hover:shadow-xl">
                        <span>Continuar a Bonos</span>
                        <i class="fas fa-arrow-right ml-3"></i>
                    </a>
                </div>
            </div>
        `;

        // Add new results after the form
        const formElement = document.querySelector('form');
        formElement.insertAdjacentHTML('afterend', resultsHTML);

        // Re-initialize JavaScript for the new elements
        initializeAfterUpdate();

        console.log('Results updated successfully');
    }

    function showError(message) {
        // Create error alert
        const alertHTML = `
            <div class="p-4 rounded-xl shadow-sm border-l-4 border-red-500 bg-red-50 text-red-800 mb-6">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-red-500 mr-3"></i>
                    <div class="flex-1">${message}</div>
                    <button type="button" class="text-red-400 hover:text-red-600 ml-4" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;

        // Add error before form
        const formElement = document.querySelector('form');
        formElement.insertAdjacentHTML('beforebegin', alertHTML);
    }
</script>
{% endblock %}
{% endblock %}
